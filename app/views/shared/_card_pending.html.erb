<div class="renata-card pending-card text-white" id="task_<%= task.id %>">
  <!-- Card Body -->
  <div class="card-body">
    <h4 class="task-title"><%= task.name %></h4>
    <p class="card-text"><%= task.description %></p>
    <p>XP Reward: <strong><%= task.xp || 0 %> XP</strong></p>

    <% if task.daily? %>
      <p><em>Daily Quest</em></p>
    <% end %>

    <% visible_participants = task.task_participants.where.not(status: "declined") %>
    <% if visible_participants.any? %>
      <p>
        Participants:
        <% visible_participants.each do |tp| %>
          <% css_class = tp.status == "pending" ? "pending-player" : "accepted-player" %>
          <span class="<%= css_class %>"><%= tp.user.username %></span><%= "," unless tp == visible_participants.last %>
        <% end %>
      </p>
    <% else %>
      <p>Creator: <%= task.user.username %></p>
    <% end %>
  </div>

  <!-- Card Footer / Buttons -->
  <div class="card-footer actions-footer">

    <!-- Complete Button triggers update in DB -->
    <%= button_to complete_task_path(task), method: :patch, class: "btn btn-icon primary-btn" do %>
      <i class="bi bi-check2-square"></i>
    <% end %>

    <!-- Ignore Button -->
    <%= button_to ignore_task_path(task), method: :patch, class: "btn btn-icon frozen-btn" do %>
      <i class="bi bi-snow"></i>
    <% end %>

    <!-- Owner-only buttons -->
    <% if task.user == current_user %>
      <button class="btn btn-icon invite-btn" type="button" data-bs-toggle="collapse" data-bs-target="#inviteForm_<%= task.id %>">
        <i class="bi bi-person-plus-fill"></i>
      </button>
      <%= link_to edit_task_path(task), class: "btn btn-icon edit-btn" do %>
        <i class="bi bi-pencil-square"></i>
      <% end %>
    <% end %>

    <!-- Badge Status -->
    <div class="task-badge">
      <% if task.completed %>
        <span class="badge bg-success"></span>
      <% elsif task.ignored %>
        <span class="badge bg-primary text-dark"></span>
      <% else %>
        <span class="badge bg-warning text-dark"></span>
      <% end %>
    </div>

  </div>

  <!-- Invite Form (owner only) -->
  <% if task.user == current_user %>
    <div class="collapse w-100 mt-2" id="inviteForm_<%= task.id %>">
      <% all_friends = current_user.friends + current_user.inverse_friends %>
      <% invited_user_ids = task.task_participants.pluck(:user_id) %>
      <% available_friends = all_friends.reject { |f| invited_user_ids.include?(f.id) } %>

      <% if available_friends.any? %>
        <%= form_with url: invite_friend_task_path(task), method: :post, local: true do |f| %>
          <div class="mb-2">
            <%= select_tag :friend_id, options_from_collection_for_select(available_friends, :id, :username), include_blank: "Choose a friend", class: "task-form-select" %>
          </div>
          <%= f.submit "Send Invite", class: "btn send-btn" %>
        <% end %>
      <% else %>
        <p class="text-muted">No friends available.</p>
      <% end %>
    </div>
  <% end %>

</div> _card_pending
