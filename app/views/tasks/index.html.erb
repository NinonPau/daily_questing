<% if user_signed_in? %>
  <h3 class="mb-4 text-center" style="font-size:1.8rem; color:#2c3e50;">Your Quests</h3>

  <!-- Back button -->
  <div class="mb-3 back-link">
    <%= link_to "Back", root_path, class: "btn btn-secondary" %>
  </div>

  <!-- list of today's tasks only -->
  <%# <div class="quests-container mx-auto renatacut-grid" style="max-width: 700px; padding: 0 20px;">
    <% current_user.tasks.where(date: Date.today).each do |quest| %>
    <!--only the task of the day are display -->
      <%# <div class="mb-4">
        <%# <div class="card shadow-sm " style="border-radius:15px; background-color: <%= quest.ignored ? 'grey' : '#f9f9f9' %>
          <%# <div class="card-header d-flex justify-content-between align-items-center"
               style="background-color:#3498db; color:white; font-weight:bold; border-top-left-radius:15px; border-top-right-radius:15px;">
            <span><%= quest.name</span>
            <%# <% if quest.completed %>
              <%# <span class="badge bg-success" style="font-size:0.9rem;">Completed</span>
            <% elsif quest.ignored%>
              <%# <span class="badge bg-primary text-dark" style="font-size:0.9rem;">Freezed</span>
            <% else  %>
              <%# <span class="badge bg-warning text-dark" style="font-size:0.9rem;">Pending</span>
            <% end %>

             <!-- NEW PART FROM Lucille-->
  <div class="quests-container mx-auto" style="max-width: 700px; padding: 0 20px;">

    <!-- Pending Invitations -->
    <% if @pending_invitations.any? %>
      <h4 class="mb-3">Invitations in Waiting</h4>
      <% @pending_invitations.each do |task| %>
        <div class="mb-4" id="task_<%= task.id %>">
          <div class="card shadow-sm renata-card" style="border-radius:15px; background-color: #f0f8ff;">
            <div class="card-header d-flex justify-content-between align-items-center"
                 style="background-color:#3498db; color:white; font-weight:bold; border-top-left-radius:15px; border-top-right-radius:15px;">
              <span><%= task.name %></span>
              <span class="badge text-white" style="background-color:#9b59b6;">Invitation</span>
            </div>

            <div class="card-body text-center">
              <p class="card-text"><%= task.description %></p>
              <p>XP Reward: <strong><%= task.xp || 0 %> XP</strong></p>
              <% if task.daily? %>
                <p><em>Daily Quest</em></p>
              <% else %>
                <p><em>For <%= task.date.strftime("%d %b %Y") %></em></p>
              <% end %>
              <p>Creator: <%= task.user.username %></p>
            </div>

            <div class="card-footer text-center">
              <%= button_to "Accept", accept_invitation_task_path(task),
                    method: :patch,
                    class: "btn btn-success btn-sm me-2" %>
              <%= button_to "Decline", decline_invitation_task_path(task),
                    method: :patch,
                    class: "btn btn-danger btn-sm" %>
            </div>
          </div>
        </div>
      <% end %>
    <% end %>

          <!-- background-img-->
          <%# <% if quest.ignored %>
          <%# <div class="card-body text-center" style="line-height:1.5; font-size:1rem; background-image: url('https://media.istockphoto.com/id/495628225/cs/fotografie/ledov%C3%BD-r%C3%A1m.jpg?s=2048x2048&w=is&k=20&c=UT3HK2jAfs5tb8uJyGsJKyCREfNc5_qCYMqgMQdzScw='); ">
          <% else %>
          <%# <div class="card-body text-center" style="line-height:1.5; font-size:1rem; ">
          <% end %>
            <%# <p class="card-text"><%= quest.description</p> %>
            <%# <p>XP Reward: <strong><%= quest.xp || 0 XP</strong></p> %>
            <%# <% if quest.daily? %>
              <%# <p><em>Daily Quest</em></p>
            <% else %>
              <%# <p><em>For <%= quest.date.strftime("%d %b %Y")</em></p> %>
            <%# <% end %>
          <%# </div>
          <div class="task-item" style="display: flex; justify-content: flex-end; align-items: center;">
            <%= link_to edit_task_path(quest), class: "edit_button fs-2" do %>
              <%# ✏️
            <% end %>
          <%# </div> %>
    <!-- Your Created Quests + Accepted Partner Quests -->
    <% if @tasks.any? || @partner_tasks.any? %>
      <h4 class="mb-3">Your Quests</h4>
      <% (@tasks + @partner_tasks).each do |task| %>
        <% invitation = task.duo && task.partner_id == current_user.id && !task.completed %>

        <div class="mb-4" id="task_<%= task.id %>">
          <div class="card shadow-sm"
               style="border-radius:15px;  background-color: <%= invitation ? '#f0f8ff' : 'transparent' %>;
            background-color: <%= invitation ? '#f0f8ff' : 'transparent' %>;
              <%= 'background-image: url("https://media.istockphoto.com/id/94344269/photo/blue-ice-framing-blank-pale-blue-background.jpg?s=612x612&w=0&k=20&c=bbxu4-98Qqi3Q4bH0SwpUdvgeBY-Her6TdcC5fdu76c="); background-size: cover; background-position: center;' if task.ignored %>">
            <div class="card-header d-flex justify-content-between align-items-center"
                 style="background-color:#3498db; color:white; font-weight:bold; border-top-left-radius:15px; border-top-right-radius:15px;">
              <span><%= task.name %></span>

              <% if invitation %>
                <!-- handled above -->
              <% else %>
                <% if task.partner.present? %>
                  <span class="badge text-white" style="background-color:#9b59b6;">Partner Quest</span>
                <% end %>

                <% if task.completed %>
                  <span class="badge bg-success">Completed</span>
                <% elsif task.ignored %>
                  <span class="badge bg-primary text-dark">Freezed</span>
                <% else %>
                  <span class="badge bg-warning text-dark">Pending</span>
                <% end %>
              <% end %>
            </div>

            <div class="card-body text-center">
              <p class="card-text"><%= task.description %></p>
              <p>XP Reward: <strong><%= task.xp || 0 %> XP</strong></p>
              <% if task.daily? %>
                <p><em>Daily Quest</em></p>
              <% else %>
                <p><em>For <%= task.date.strftime("%d %b %Y") %></em></p>
              <% end %>

              <%# --- Participants & Ask for Help --- %>
              <% unless task.completed %>
                <p>Participants: <%= task.user.username %>
                  <% if task.partner.present? %>, <%= task.partner.username %> <% end %>
                </p>

                <% if task.user == current_user %>
                  <% available_friends = current_user.friends.reject { |f| f == task.partner } %>
                  <% if available_friends.any? %>
                    <div class="mt-2">
                      <%= form_with url: invite_friend_task_path(task), method: :post, local: true do |f| %>
                        <div class="mb-2">
                          <%= select_tag :friend_id,
                                options_from_collection_for_select(available_friends, :id, :username),
                                include_blank: "Choose a friend",
                                class: "form-select" %>
                        </div>
                        <%= f.submit "Send Invite", class: "btn btn-primary btn-sm" %>
                      <% end %>
                    </div>
                  <% else %>
                    <p class="text-muted">No friends available to invite.</p>
                  <% end %>
                <% end %>
              <% end %>
            </div>

            <div class="task-item" style="display: flex; justify-content: flex-end;">
              <% unless task.completed %>
                <%= link_to edit_task_path(task), class: "edit_button fs-2" do %> ✏️ <% end %>
              <% end %>
            </div>

            <% unless invitation %>
              <div class="card-footer text-center">
                <% unless task.completed %>
                  <% if task.ignored %>
                    <%= button_to "Unfreeze", unignore_task_path(task), method: :patch,
                          class: "btn btn-primary btn-sm" %>
                  <% else %>
                    <%= button_to "Mark as Done", complete_task_path(task), method: :patch,
                          class: "btn btn-success btn-sm me-2" %>
                    <%= button_to "Mark as Freeze", ignore_task_path(task), method: :patch,
                          class: "btn btn-warning btn-sm" %>
                  <% end %>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>

  <!-- Add new quest button -->
  <div class="mt-4 text-center">
    <%= link_to "Add New Quest", new_task_path, class: "btn btn-primary btn-lg", style: "border-radius:12px;" %>
  </div>
    <% else %>
      <%= render "public_home" %>
    <% end %>
