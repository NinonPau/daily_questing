<% if user_signed_in? %>
  <!-- Page header -->
  <h3 class="mb-4 text-center page-title">Your Quests</h3>

  <!-- Sticky Add / Random Quest buttons -->
  <div class="quest-actions sticky-actions">
    <%= link_to "Add Quest", new_task_path, class: "btn btn-new-quest" %>
    
    <%= simple_form_for :task, url: random_tasks_path do |f| %>
      <%= f.submit "Random Quest", class: "btn btn-random-quest" %>
    <% end %>
  </div>

  <!-- Quest container -->
  <div class="quests-container">

    <!-- Pending invitations -->
    <% if current_user.pending_invitations.any? %>
      <h4 class="mb-3">Invitations in Waiting</h4>
      <% current_user.pending_invitations.each do |task| %>
        <div class="mb-4" id="task_<%= task.id %>">
          <%= render 'shared/card_pending', task: task %>
        </div>
      <% end %>
    <% end %>

    <!-- Created & Accepted Quests -->
    <% visible_tasks = (@tasks + @participating_tasks).uniq.select do |task|
         task.user == current_user || task.task_participants.exists?(user: current_user, status: "accepted")
       end.sort_by(&:created_at).reverse %>

    <% if visible_tasks.any? %>
      <% visible_tasks.each do |task| %>
        <div class="mb-4" id="task_<%= task.id %>">
          <% if task.completed? %>
            <%= render 'shared/card_completed', task: task %>
          <% elsif task.ignored? %>
            <%= render 'shared/card_frozen', task: task %>
          <% else %>
            <%= render 'shared/card_pending', task: task %>
          <% end %>
        </div>
      <% end %>
    <% else %>
      <p class="text-center text-muted">No quests found.</p>
    <% end %>

  </div> <!-- /quests-container -->

<% else %>
  <%= render "public_home" %>
<% end %>
