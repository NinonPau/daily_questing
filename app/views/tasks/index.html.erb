<% if user_signed_in? %>

  <!-- Header -->
  <h3 class="mb-4 text-center" style="font-size:1.8rem; color:#2c3e50;">Your Quests</h3>

  <!-- Back button -->
  <div class="mb-3 back-link">
    <%= link_to "Back", root_path, class: "btn btn-secondary" %>
  </div>

  <!-- list of today's tasks only -->

  <!-- Task container -->
  <div class="quests-container mx-auto" style="max-width: 700px; padding: 0 20px;">

    <!--Pending invitations -->

    <!-- Defining pending_invitations variable -->
    <% pending_invitations = current_user.pending_invitations.reject do |task|
         task.task_participants.find_by(user: current_user)&.status == "declined"
       end %>

    <%# List of pending invitation %>
    <% if pending_invitations.any? %>
      <h4 class="mb-3">Invitations in Waiting</h4>
      <% pending_invitations.each do |task| %>
        <div class="mb-4" id="task_<%= task.id %>">
          <%# card template %>
          <div class="card shadow-sm renata-card" style="border-radius:15px; background-color: #f0f8ff;">
            <div class="card-header d-flex justify-content-between align-items-center"
                 style="background-color:#3498db; color:white; font-weight:bold; border-top-left-radius:15px; border-top-right-radius:15px;">
              <span><%= task.name %></span>
              <span class="badge text-white" style="background-color:#9b59b6;">Invitation</span>
            </div>
            <div class="card-body text-center">
              <p class="card-text"><%= task.description %></p>
              <p>XP Reward: <strong><%= task.xp || 0 %> XP</strong></p>
              <% if task.daily? %>
                <p><em>Daily Quest</em></p>
              <% else %>
                <p><em>For <%= task.date.strftime("%d %b %Y") %></em></p>
              <% end %>
              <p>Creator: <%= task.user.username %></p>
            </div>
            <div class="card-footer text-center">
              <%= button_to "Accept", accept_invitation_task_path(task), method: :patch, class: "btn btn-success btn-sm me-2" %>
              <%= button_to "Decline", decline_invitation_task_path(task), method: :patch, class: "btn btn-danger btn-sm" %>
            </div>
          </div>

        </div>
      <% end %>
    <% end %>

  <!--Created & Accepted Quests -->

    <!-- Defining the visible_task variable  -->
    <% visible_tasks = (@tasks + @participating_tasks).uniq.select do |task|
         task.user == current_user || task.task_participants.exists?(user: current_user, status: "accepted")
       end.sort_by(&:created_at).reverse %>

     <!-- List of Created & Accepted Quests -->
    <% if visible_tasks.any? %>
      <% visible_tasks.each do |task| %>
        <div class="mb-4" id="task_<%= task.id %>">

          <% if task.completed %>
            <%= render 'shared/card_completed', object: @task %>
          <% elsif task.ignored %>
            <%= render 'shared/card_frozen', object: @task %>
          <% else %>
            <%= render partial 'shared/card_pending', object: @task %>
          <% end %>

        </div>
      <% end %>
    <% end %>
  </div>

  <!--New quest button-->
  <div class="mt-4 text-center">
    <%= link_to "Add New Quest", new_task_path, class: "btn btn-primary btn-lg", style: "border-radius:12px;" %>
  </div>
    <% else %>
      <%= render "public_home" %>
    <% end %>
