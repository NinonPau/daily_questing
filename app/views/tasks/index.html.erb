<%# app/views/tasks/index.html.erb %>
<% if user_signed_in? %>
  <h3 class="mb-4 text-center" style="font-size:1.8rem; color:#2c3e50;">Your Quests</h3>

  <!-- go back to home page button -->
  <div class="mb-3 back-link">
    <%= link_to "Back", root_path, class: "btn btn-secondary" %>
  </div>

  <% if flash[:notice] %>
    <div class="alert alert-success mt-2">
      <%= flash[:notice] %>
    </div>
  <% end %>

  <div class="quests-container mx-auto" style="max-width: 700px; padding: 0 20px;">
    <% all_tasks = @tasks + @invited_tasks %>
    <% all_tasks.each do |task| %>
      <% card_color = task.user == current_user ? '#f9f9f9' : '#d1e7dd' %>
      <div class="mb-4">
        <div class="card shadow-sm" style="border-radius:15px; background-color: <%= card_color %>;">
          <div class="card-header d-flex justify-content-between align-items-center"
               style="background-color:#3498db; color:white; font-weight:bold; border-top-left-radius:15px; border-top-right-radius:15px;">
            <span><%= task.name %></span>
            <% if task.completed %>
              <span class="badge bg-success" style="font-size:0.9rem;">Completed</span>
            <% elsif quest.ignored%>
              <span class="badge bg-primary text-dark" style="font-size:0.9rem;">Freezed</span>
            <% else  %>
              <span class="badge bg-warning text-dark" style="font-size:0.9rem;">Pending</span>
            <% end %>
          </div>

          <div class="card-body text-center" style="line-height:1.5; font-size:1rem;">
            <p class="card-text"><%= task.description %></p>
            <p>XP Reward: <strong><%= task.xp || 0 %> XP</strong></p>
            <% if task.daily? %>
              <p><em>Daily Quest</em></p>
            <% else %>
              <p><em>For <%= task.date.strftime("%d %b %Y") %></em></p>
            <% end %>

            <%# Render partial pour Ask for Help et participants %>
            <%= render "ask_for_help", task: task %>
          </div>

          <div class="card-footer text-center" style="border-radius:0 0 15px 15px;">
            <% unless task.completed %>
              <% if task.user == current_user %>
                <%= button_to "Mark as Done", complete_task_path(task), method: :patch,
                      class: "btn btn-success btn-sm", style: "min-width:120px; display:inline-block;" %>
                <%= button_to "Mark as Freeze", ignore_task_path(task), method: :patch,
                      class: "btn btn-warning btn-sm", style: "min-width:120px; display:inline-block;" %>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>

  <div class="mt-4 text-center">
    <%= link_to "Add New Quest", new_task_path, class: "btn btn-primary btn-lg", style: "border-radius:12px;" %>
  </div>

<% else %>
  <%= render "public_home" %>
<% end %>
