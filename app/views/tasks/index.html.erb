<h2 class="text-center mb-4">Your Quests</h2>

<div class="mb-3">
  <%= link_to "Back to Home", root_path, class: "btn btn-secondary" %>
</div>

<div class="quests-container mx-auto" style="max-width: 700px; padding: 0 20px;">

  <!-- Pending Invitations -->
  <% pending_tasks = current_user.pending_invitations %>
  <% if pending_tasks.any? %>
    <h3 class="mb-3">Invitations in Waiting</h3>
    <% pending_tasks.each do |task| %>
      <div class="card mb-3 shadow-sm" style="border-radius:12px;">
        <div class="card-header d-flex justify-content-between align-items-center" style="background-color:#3498db; color:white;">
          <span><%= task.name %></span>
          <span class="badge bg-warning text-dark">Invitation</span>
        </div>
        <div class="card-body">
          <p><%= task.description %></p>
          <p>XP Reward: <strong><%= task.xp || 0 %> XP</strong></p>
          <% if task.daily? %>
            <p><em>Daily Quest</em></p>
          <% else %>
            <p><em>For <%= task.date.strftime("%d %b %Y") %></em></p>
          <% end %>
          <p>Creator: <%= task.user.username %></p>
        </div>
        <div class="card-footer text-center">
          <%= button_to "Accept", accept_invitation_task_path(task), method: :patch, class: "btn btn-success me-2" %>
          <%= button_to "Decline", decline_invitation_task_path(task), method: :patch, class: "btn btn-danger" %>
        </div>
      </div>
    <% end %>
  <% end %>

  <!-- User's own tasks for today -->
  <% todays_tasks = current_user.tasks.where(date: Date.today) %>
  <% if todays_tasks.any? %>
    <h3 class="mt-4 mb-3">Your Quests</h3>
    <% todays_tasks.each do |task| %>
      <div class="card mb-3 shadow-sm" style="border-radius:12px;">
        <div class="card-header d-flex justify-content-between align-items-center" style="background-color:#2c3e50; color:white;">
          <span><%= task.name %></span>
          <% if task.completed %>
            <span class="badge bg-success">Completed</span>
          <% else %>
            <span class="badge bg-primary">Pending</span>
          <% end %>
        </div>
        <div class="card-body">
          <p><%= task.description %></p>
          <p>XP Reward: <strong><%= task.xp || 0 %> XP</strong></p>
          <% if task.daily? %>
            <p><em>Daily Quest</em></p>
          <% else %>
            <p><em>For <%= task.date.strftime("%d %b %Y") %></em></p>
          <% end %>

          <% if task.user == current_user %>
            <h5>Invite Friends</h5>
            <% if current_user.friends.any? %>
              <%= form_with url: invite_friend_task_path(task), method: :post, local: true do |f| %>
                <div class="mb-2">
                  <%= select_tag :friend_id,
                        options_from_collection_for_select(current_user.friends.reject { |f| task.participants.include?(f) }, :id, :username),
                        include_blank: "Choose a friend",
                        class: "form-select" %>
                </div>
                <%= f.submit "Send Invite", class: "btn btn-primary btn-sm" %>
              <% end %>
            <% else %>
              <p class="text-muted">You have no friends to invite.</p>
            <% end %>
          <% end %>

          <% if task.participants.any? %>
            <p class="mt-2">Participants: <%= task.participants.map(&:username).join(", ") %></p>
          <% end %>
        </div>
        <div class="card-footer text-center">
          <% unless task.completed %>
            <%= link_to "Mark as Done", complete_task_path(task), method: :patch, class: "btn btn-success me-2" %>
            <% if task.ignored %>
              <%= link_to "Unfreeze", unignore_task_path(task), method: :patch, class: "btn btn-primary" %>
            <% else %>
              <%= link_to "Freeze", ignore_task_path(task), method: :patch, class: "btn btn-warning" %>
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>

  <!-- Tasks where current_user participates -->
  <% if @participating_tasks.any? %>
    <h3 class="mt-4 mb-3">Quests You're Participating In</h3>
    <% @participating_tasks.each do |task| %>
      <div class="card mb-3 shadow-sm" style="border-radius:12px;">
        <div class="card-header d-flex justify-content-between align-items-center" style="background-color:#16a085; color:white;">
          <span><%= task.name %></span>
          <% if task.completed %>
            <span class="badge bg-success">Completed</span>
          <% else %>
            <span class="badge bg-warning text-dark">Pending</span>
          <% end %>
        </div>
        <div class="card-body">
          <p><%= task.description %></p>
          <p>XP Reward: <strong><%= task.xp || 0 %> XP</strong></p>
          <p>Creator: <%= task.user.username %></p>
          <% if task.participants.any? %>
            <p>Participants: <%= task.participants.map(&:username).join(", ") %></p>
          <% end %>
        </div>
        <div class="card-footer text-center">
          <% unless task.completed %>
            <%= link_to "Mark as Done", complete_task_path(task), method: :patch, class: "btn btn-success" %>
          <% end %>
        </div>
      </div>
    <% end %>
  <% end %>

</div>

<div class="mt-4 text-center">
  <%= link_to "Add New Quest", new_task_path, class: "btn btn-primary btn-lg", style: "border-radius:12px;" %>
</div>
