<% all_friends = current_user.friends + current_user.inverse_friends %>
<% invited_user_ids = task.task_participants.pluck(:user_id) %>
<% available_friends = all_friends.reject { |f| invited_user_ids.include?(f.id) } %>

<div class="mt-2">
  <button class="btn btn-secondary btn-sm mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#inviteForm_<%= task.id %>">
    Invite Friends
  </button>
  <div class="collapse" id="inviteForm_<%= task.id %>">
    <% if available_friends.any? %>
      <%= form_with url: invite_friend_task_path(task), method: :post, local: true do |f| %>
        <div class="mb-2">
          <%= select_tag :friend_id, options_from_collection_for_select(available_friends, :id, :username),
                include_blank: "Choose a friend", class: "form-select" %>
        </div>
        <%= f.submit "Send Invite", class: "btn btn-primary btn-sm" %>
      <% end %>
    <% else %>
      <p class="text-muted">No friends available to invite.</p>
    <% end %>
  </div>
</div>
