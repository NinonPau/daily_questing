<div class="mb-4" id="task_<%= task.id %>">
  <div class="card shadow-sm" style="border-radius:15px; background-color: <%= bg_color || '#f9f9f9' %>;">
    <div class="card-header d-flex justify-content-between align-items-center"
         style="background-color:#3498db; color:white; font-weight:bold; border-top-left-radius:15px; border-top-right-radius:15px;">
      <span><%= task.name %></span>

      <% accepted_participants = task.task_participants.where(status: "accepted") %>
      <% if accepted_participants.count > 1 %>
        <span class="badge text-white" style="background-color:#9b59b6;">Partner Quest</span>
      <% end %>

      <% if task.completed %>
        <span class="badge bg-success">Completed</span>
      <% elsif task.ignored %>
        <span class="badge bg-primary text-dark">Freezed</span>
      <% else %>
        <span class="badge bg-warning text-dark">Pending</span>
      <% end %>
    </div>

    <div class="card-body text-center">
      <p class="card-text"><%= task.description %></p>
      <p>XP Reward: <strong><%= task.xp || 0 %> XP</strong></p>
      <% if task.daily? %>
        <p><em>Daily Quest</em></p>
      <% else %>
        <p><em>For <%= task.date.strftime("%d %b %Y") %></em></p>
      <% end %>

      <!-- Participants with status color -->
      <% visible_participants = task.task_participants.where.not(status: "declined") %>
      <% if visible_participants.any? %>
        <p>
          Participants:
          <% visible_participants.each do |tp| %>
            <% css_class = case tp.status
              when "pending" then "text-warning fw-bold"
              when "accepted" then "text-primary fw-bold"
              else ""
            end %>
            <span class="<%= css_class %>"><%= tp.user.username %></span><%= "," unless tp == visible_participants.last %>
          <% end %>
        </p>
      <% else %>
        <p>Creator: <%= task.user.username %></p>
      <% end %>

      <!-- Invite friends (only creator) - collapsible -->
      <% if task.user == current_user && !task.completed %>
        <div class="mt-2">
          <button class="btn btn-secondary btn-sm mb-2" type="button" data-bs-toggle="collapse" data-bs-target="#inviteForm_<%= task.id %>">
            Invite Friends
          </button>
          <div class="collapse" id="inviteForm_<%= task.id %>">
            <% all_friends = current_user.friends + current_user.inverse_friends %>
            <% invited_user_ids = task.task_participants.pluck(:user_id) %>
            <% available_friends = all_friends.reject { |f| invited_user_ids.include?(f.id) } %>
            <% if available_friends.any? %>
              <%= form_with url: invite_friend_task_path(task), method: :post, local: true do |f| %>
                <div class="mb-2">
                  <%= select_tag :friend_id, options_from_collection_for_select(available_friends, :id, :username),
                        include_blank: "Choose a friend", class: "form-select" %>
                </div>
                <%= f.submit "Send Invite", class: "btn btn-primary btn-sm" %>
              <% end %>
            <% else %>
              <p class="text-muted">No friends available to invite.</p>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Task actions -->
    <div class="card-footer text-center">
      <% unless task.completed %>
        <% if task.ignored %>
          <%= button_to "Unfreeze", unignore_task_path(task), method: :patch, class: "btn btn-primary btn-sm" %>
        <% else %>
          <%= button_to "Mark as Done", complete_task_path(task), method: :patch, class: "btn btn-success btn-sm me-2" %>
          <%= button_to "Mark as Freeze", ignore_task_path(task), method: :patch, class: "btn btn-warning btn-sm" %>
        <% end %>
      <% end %>
    </div>
  </div>
</div>

